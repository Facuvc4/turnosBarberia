<%- include('partials/header') %>
<section class="container flex-grow-1">
    <div class="d-flex flex-column align-items-center">
    <h2 class="my-4 text-center">Turnos disponibles</h2>
    <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addShiftModal">
        +
      </button>
    </div>
    <div class="row">
      <% dates.forEach(function(date) { %>
      <div class="col-md-4 mb-3">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Fecha: <%= date.formattedDate %></h5>
            <p class="card-text">
              De: <%= date.initHour %>hs a <%= date.endHour %>hs
            </p>
            <p class="card-text">
              Estado: <% if(date.status) { %>
              <span class="badge bg-success">Disponible</span>
              <% } else { %>
              <span class="badge bg-danger">Tomado</span>
              <% } %>
            </p>
            <% if(date.status) { %>
            <a class="btn btn-primary" id="takeShift" data-id="<%= date.id %>">Tomar Turno</a>
            <a class="btn btn-warning m-3" id="deleteDate" data-id="<%= date.id %>">Eliminar</a>
            <% } %>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
  </section>
  

  <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addShiftModalLabel">Agregar Turno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addShiftForm">
            <div class="mb-3">
              <label for="shiftDate" class="form-label">Fecha</label>
              <input type="date" class="form-control" id="shiftDate" required>
            </div>
            <div class="mb-3">
              <label for="initHour" class="form-label">Hora de inicio</label>
              <select class="form-select" id="initHour" required>
                <% for(let i = 0; i < 24; i++) { %>
                <option value="<%= i %>"><%= ('0' + i).slice(-2) %></option>
                <% } %>
              </select>
            </div>
            <div class="mb-3">
              <label for="endHour" class="form-label">Hora de fin</label>
              <select class="form-select" id="endHour" required>
                <% for(let i = 0; i < 24; i++) { %>
                <option value="<%= i %>"><%= ('0' + i).slice(-2) %></option>
                <% } %>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">Agregar</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('addShiftForm').addEventListener('submit', function(event) {
  event.preventDefault();

  const date = document.getElementById('shiftDate').value;
  const initHour = document.getElementById('initHour').value;
  const endHour = document.getElementById('endHour').value;
  console.log(date);

  fetch('/date/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ date, initHour, endHour }),
  })
  .then(response => {
    if (response.status === 200) {
      window.location.reload();
    } else {
      console.error('Error al agregar el turno');
    }
  })
  .catch(error => {
    console.error('Error:', error);
  });
});

document.querySelectorAll('#deleteDate').forEach(function(button) {
      button.addEventListener('click', function() {
        const confirm = window.confirm('¿Deseas eliminar este turno?');
       if (confirm) {
        const idDate = this.getAttribute('data-id');
        fetch('/date/delete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ idDate }),
        })
        .then(response => {
          if (response.status === 200) {
            window.location.href = '/';
          } else {
            console.error('Error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }
      });
    });

    document.querySelectorAll('#takeShift').forEach(function(button) {
      button.addEventListener('click', function() {
        const confirm = window.confirm('¿Deseas tomar este turno?');
       if (confirm) {
        const idDate = this.getAttribute('data-id');
        fetch('/shift/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ idDate }),
        })
        .then(response => {
          if (response.status === 200) {
            window.location.href = '/shifts/own';
          } else {
            console.error('Error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }
      });
    });
  </script>
<%- include('partials/footer') %>